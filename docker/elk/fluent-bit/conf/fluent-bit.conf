# =============================================================================
# Fluent Bit 4.0 설정
# =============================================================================

[SERVICE]
    Log_Level    info
    Daemon       Off
    Refresh_Interval    1
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020
    Parsers_File parsers.conf
    Flush        1
    Grace        5

# =============================================================================
# INPUT 섹션 - ERROR 전용 TCP 입력 추가
# =============================================================================

# TCP 입력 - log4j2에서 직접 전송 (주요 입력)
[INPUT]
    Name        tcp
    Tag         java.tcp
    Listen      0.0.0.0
    Port        24224
    Format      json
    Chunk_Size  32
    Buffer_Size 64

# SQL 전용 TCP 입력 - p6spy 로그 수집
[INPUT]
    Name        tcp
    Tag         java.sql
    Listen      0.0.0.0
    Port        24225
    Format      json
    Chunk_Size  16
    Buffer_Size 32

# ERROR 전용 TCP 입력 추가 - 멀티라인 스택트레이스 처리
[INPUT]
    Name        tcp
    Tag         java.error
    Listen      0.0.0.0
    Port        24226
    Format      json
    Chunk_Size  32
    Buffer_Size 64

# =============================================================================
# FILTER 섹션 - ERROR 로그 데이터 정제 및 태깅
# =============================================================================

# 일반 TCP 로그 데이터 정제 및 태깅
[FILTER]
    Name    modify
    Match   java.tcp
    Add     source tcp

# SQL 로그 데이터 정제 및 파싱
[FILTER]
    Name    modify
    Match   java.sql
    Add     source tcp
    Add     log_category sql

# ERROR TCP 로그 데이터 정제 및 태깅
[FILTER]
    Name    modify
    Match   java.error
    Add     source tcp
    Add     log_category error
    Add     priority critical
    Add     alert_required true

# 에러 레벨 로그 우선순위 설정
[FILTER]
    Name    modify
    Match   java.*
    Condition Key_value_matches level ^ERROR$
    Add     priority critical
    Add     alert_required true

# =============================================================================
# OUTPUT 섹션
# =============================================================================

# TCP 로그 → Elasticsearch (실시간)
[OUTPUT]
    Name es
    Match java.tcp
    Host elasticsearch
    Port 9200
    Logstash_Format On
    Logstash_Prefix application-logs-tcp
    Logstash_DateFormat %Y.%m.%d
    suppress_type_name On
    include_tag_key On
    Generate_ID On
    Buffer_Size 1MB
    Retry_Limit 5
    Workers 2

# SQL 로그 → Elasticsearch (전용 인덱스)
[OUTPUT]
    Name es
    Match java.sql
    Host elasticsearch
    Port 9200
    Logstash_Format On
    Logstash_Prefix application-logs-sql
    Logstash_DateFormat %Y.%m.%d
    suppress_type_name On
    include_tag_key On
    Generate_ID On
    Buffer_Size 512KB
    Retry_Limit 3
    Workers 1

# ERROR TCP 로그 → Elasticsearch (최우선 처리)
[OUTPUT]
    Name es
    Match java.error
    Host elasticsearch
    Port 9200
    Logstash_Format On
    Logstash_Prefix application-logs-error
    Logstash_DateFormat %Y.%m.%d
    suppress_type_name On
    include_tag_key On
    Generate_ID On
    Buffer_Size 1MB
    Retry_Limit 5
    Workers 2

# DEBUG 출력 (개발 중에만 사용)
[OUTPUT]
    Name  stdout
    Match java.*
    Format json_lines
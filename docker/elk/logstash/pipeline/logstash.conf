input {
  tcp {
    port => 5044
    type => "log4j2"
  }
}

filter {
  if [type] == "log4j2" {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{LOGLEVEL:level}\] \[%{DATA:thread}\] %{DATA:logger} - %{GREEDYDATA:log_message}"
      }
      tag_on_failure => ["_grokparsefailure"]
    }

    # Grok 파싱 실패시 기본값 설정
    if "_grokparsefailure" in [tags] {
      mutate {
        add_field => { "log_message" => "%{message}" }
        add_field => { "level" => "INFO" }
        add_field => { "logger" => "unknown" }
        add_field => { "thread" => "unknown" }
        remove_tag => ["_grokparsefailure"]
      }
    }

    # 타임스탬프 변환
    if [timestamp] {
      date {
        match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
        target => "@timestamp"
      }
    }

    # 추가 필드
    mutate {
      add_field => { "application" => "kmac-service" }
      add_field => { "environment" => "local" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "application-logs-%{+YYYY.MM.dd}"
  }
  stdout {
    codec => rubydebug
  }
}